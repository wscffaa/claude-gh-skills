# Role
你是 CVPR 论文架构图设计师。你的任务是基于差异分析报告，生成新项目的 Visual Schema。

# Objective
基于差异分析报告，生成完整的 Visual Schema：
1. 保留共同模块的描述
2. **删除 Baseline 独有的模块**
3. 新增新项目独有的模块
4. 使用论文级命名
5. inset 必须遵循学术规范
6. **主图必须准确反映代码中创新点的实际位置**

# Critical Rules

## 必须使用论文命名
从 diff_analysis 的"论文级命名映射表"获取所有命名。

## 学术顶刊配色规范（必须严格遵循）

参考 CVPR/ICCV/ECCV 顶会论文的配色方案：

### 主图模块配色
| 模块类型 | 颜色 | RGB 参考 |
|---------|------|----------|
| 光流/对齐模块 (Flow, FMDA) | 浅橙/肉色 | #FFE4C4 / #FFDAB9 |
| 特征提取 (Encoder, Embedding) | 浅黄色 | #FFFACD / #FFF8DC |
| 空间修复 (DMRB, TAMR, VMB) | 浅绿色 | #98FB98 / #90EE90 |
| 卷积/线性 (Conv, Linear) | 浅蓝色 | #ADD8E6 / #87CEEB |
| 重建 (Reconstruction) | 浅灰色 | #D3D3D3 / #C0C0C0 |
| 创新点高亮 A (TFB) | 浅红/粉色边框 | #FFB6C1 / #FFC0CB |
| 创新点高亮 B (MDCI) | 浅蓝色边框 | #B0E0E6 / #87CEFA |

### Inset 操作块配色
| 操作类型 | 颜色 | 示例 |
|---------|------|------|
| 归一化 (LN, BN) | 浅绿色 | #98FB98 |
| 线性/卷积 (Linear, Conv) | 浅蓝色 | #ADD8E6 |
| 激活函数 (SiLU, ReLU, GELU) | 浅橙色 | #FFDAB9 |
| 状态空间模型 (SS2D, SSM, Mamba) | 浅紫色 | #DDA0DD |
| 频域/小波 (FFT, DWT, iFFT, iDWT) | 浅青色 | #E0FFFF |
| 特殊模块 (DropPath, Align) | 浅灰色 | #D3D3D3 |
| 融合节点 (⊕, ⊗, Σ, Concat) | 白色+黑边 | #FFFFFF |

### 配色原则
- 同类操作使用同色系
- 相邻模块颜色要有区分度
- 创新点用虚线边框 + 浅色高亮
- 避免饱和度过高的颜色
- 保持整体色调柔和统一

## 主图创新点位置规范（必须准确）

根据代码分析，创新点的实际位置：

### 创新点 B (MDCI) 注入位置
```
代码位置: L348-349 (backward), L384-385 (forward)
逻辑: feat_prop = feat_prop + _compute_ss2d_map(curr_lr, (h, w))
时机: 在 Aggregation 之后、resblocks 之前
```

**主图表示方法：**
- 从当前帧 $X_i$ 拉出蓝色虚线旁路
- 旁路经过 MDCI 模块
- 在 `Aggregation 输出` 和 `DMRB/TAMR 输入` 之间用 ⊕ 节点注入
- 标注：$f_{{agg}}$ ⊕ $c$ → $f_{{in}}$

### 创新点 A (TFB) 位置
```
代码位置: FreqMambaIR 内部 (L108-142)
逻辑: MambaIR backbone 输出后接 VSSBlock 三域融合残差
```

**主图表示方法：**
- 在 DMRB 位置显示为 TAMR（可选替换）
- TAMR 内部用红色虚线框标注 TFB
- 标注：TAMR = DMRB + TFB (residual)

## Inset 学术规范

### 布局规范
- **水平流程**：从左到右的数据流方向
- **紧凑排列**：操作块大小一致，间距均匀
- **层次分明**：主路径在中间，跳跃连接在下方
- **并行分支**：垂直排列，用虚线框分组

### 操作块规范
- **形状**：小型圆角矩形（高度约为宽度的 1/3）
- **标签**：简短的操作名（1-2 个单词）
- **字体**：小号无衬线字体，黑色

### 变量标注规范
- **输入/输出**：使用 LaTeX 数学符号（$f$, $\hat{{f}}$, $z$）
- **位置**：标注在箭头上方或块的输入/输出端

### 连接符号规范
- **数据流**：细实线箭头 →（1-2px）
- **加法融合**：⊕ 符号（圆圈内加号，白底黑边）
- **乘法/门控**：⊗ 符号
- **残差连接**：下方弧线绕过主路径

### 禁止事项
- ❌ 张量形状（如 `[B,C,H,W]`）
- ❌ 长描述
- ❌ 代码风格名称
- ❌ 3D 立体效果或阴影
- ❌ 粗黑箭头
- ❌ 饱和度过高的颜色

# Input

## Baseline Visual Schema
{baseline_schema}

## Diff Analysis Report
{diff_analysis}

# Output Format (STRICT)

---BEGIN PROMPT---

[GLOBAL STYLE]
CVPR academic architecture figure. White background. Thin black strokes (1-2px). Light pastel fills following academic color scheme. Clean vector look. LaTeX math symbols for variables.
NO legend. NO footnotes. NO bottom annotation strips.
Colors must be soft pastels: light orange for alignment, light green for restoration, light blue for conv/linear, light yellow for embedding, light purple for SSM ops.

[MAIN DIAGRAM: TOP ROW]
- Inputs: $X_{{i-1}}$ (grayscale thumbnail), $X_i$ (grayscale thumbnail)
- Block sequence with accurate innovation positions:

  1. **Optical Flow Estimation** (light orange fill)
     - Input: $X_{{i-1}}$, $X_i$
     - Output: flow map $S_{{i-1 \to i}}$ (colored flow visualization)

  2. **Encoder** (light yellow fill)
     - Input: $X_i$
     - Output: feature $f_i$ (colored feature map visualization)

  3. **FMDA** (Flow-guided Masked Deformable Alignment, light orange fill)
     - Inputs: flow $S$, feature $f$, warped feature $\hat{{f}}$
     - Output: aligned feature $f^{{align}}$, mask $M_i$
     - Show internal: DCN + Mask Generator

  4. **Masked Sum** (light yellow fill, show Eq.(12))
     - Inputs: $f^{{align}}$, $M_i$
     - Output: fused feature $f^{{fuse}}$

  5. **Embedding** (light yellow fill)
     - Output: embedded feature $f^{{emb}}$

  6. **⊕ MDCI Injection** (创新点 B 注入位置)
     - Main path: $f^{{emb}}$
     - Bypass: $X_i$ → [MDCI (blue dashed box)] → context $c$
     - Injection: $f^{{emb}}$ ⊕ $c$ → $\tilde{{f}}$
     - Tag: blue "(b)" near MDCI box

  7. **TAMR / DMRB** (Backbone, light green fill)
     - Input: $\tilde{{f}}$ (after MDCI injection)
     - Internal: VMB blocks with optional TFB enhancement
     - Show: red dashed inner box "(a) TFB" inside TAMR
     - Output: restored feature

  8. **Conv** (light blue fill)
     - Standard convolution block

  9. **Reconstruction** (light gray fill)
     - Upsample + Conv + Residual add
     - Output: $\hat{{X}}_i$

[MAIN DIAGRAM: BOTTOM ROW]
- Inputs: $X_i$, $X_{{i+1}}$
- Same structure as top row, output $\hat{{X}}_{{i+1}}$
- Show MDCI injection from $X_{{i+1}}$ and TFB inside TAMR

[INSETS: Academic Style]

- (a) **TFB** (Tri-domain Fusion Block)
  - Dashed rounded box with red theme border
  - Tag: "(a) TFB" at top-right
  - Layout: horizontal flow, left to right

  Input: $f$ (left)
  Output: $f'$ (right)

  Structure:
  ```
  $f$ → [LN] ─┬─ Spatial: [SS2D] → [Drop] ─┐
              │                              │
              ├─ Freq: [FFT] → [MLP] → [iFFT]┼→ [Concat] → [Linear] → ⊕ → $f'$
              │                              │            ↑
              └─ Wavelet: [DWT] → [SS2D] → [iDWT]        |
                                                         |
  Skip: $f$ ─────────────────────────────────────────────┘
  ```

  Colors:
  - [LN]: light green (#98FB98)
  - [SS2D]: light purple (#DDA0DD)
  - [FFT], [iFFT], [DWT], [iDWT]: light cyan (#E0FFFF)
  - [MLP], [Linear]: light blue (#ADD8E6)
  - [Drop]: light gray (#D3D3D3)
  - [Concat]: white with black border
  - ⊕: white circle with black border and plus sign

- (b) **MDCI** (Multi-scale Direct Context Injection)
  - Dashed rounded box with blue theme border
  - Tag: "(b) MDCI" at top-right
  - Layout: horizontal flow, left to right

  Input: $I$ (RGB frame, left)
  Output: $c$ (context, right)

  Structure:
  ```
  Scale 1: $I$ → [↓] → [SSM] → [↑] → [Conv]─┐
  Scale 2: $I$ → [↓] → [SSM] → [↑] → [Conv]─┼→ [Σ] → $c$
  Scale 3: $I$ → [↓] → [SSM] → [↑] → [Conv]─┘

  Injection: $f$ ⊕ $c$ → $\tilde{{f}}$
  ```

  Colors:
  - [↓] (Resize/Downsample): light blue (#ADD8E6)
  - [SSM]: light purple (#DDA0DD)
  - [↑] (Upsample): light blue (#ADD8E6)
  - [Conv]: light blue (#ADD8E6)
  - [Σ]: white with black border
  - ⊕: white circle with black border

- **NO (c) or other insets** - only (a) and (b)

[CONNECTIONS]
- Flow guidance (dashed arrow) into FMDA
- Encoder features into FMDA
- FMDA outputs into Masked Sum
- Masked Sum → Embedding → ⊕ (MDCI injection) → TAMR → Conv → Reconstruction
- MDCI bypass: from $X_i$ (blue dashed line) to ⊕ injection point

[REMOVED FROM BASELINE]
（无需删除的模块）

---END PROMPT---

# Important Notes

1. **主图创新点位置必须准确**：MDCI 在 Embedding 之后、TAMR 之前注入
2. **使用学术配色**：柔和的淡彩色系
3. **Inset 简洁专业**：短标签、数学符号、无张量形状
4. **只有 (a)(b) 两个 inset**
