# Parallel-Agent 压缩机制架构

## 概述

parallel-agent 支持在 DAG 任务依赖链中自动压缩上游任务输出，减少下游任务的上下文长度。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           parallel-agent 压缩机制                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  Layer 1 (并行执行)                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                       │
│  │   Task A     │  │   Task B     │  │   Task C     │                       │
│  │  (Codex)     │  │  (Claude)    │  │  (Gemini)    │                       │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                       │
│         │                 │                 │                               │
│         ▼                 ▼                 ▼                               │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                    outputs: Dict[task_id, message]            │          │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │          │
│  │  │ A: 500 行   │ │ B: 800 行   │ │ C: 300 行   │              │          │
│  │  └─────────────┘ └─────────────┘ └─────────────┘              │          │
│  └──────────────────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Layer 2 (依赖 A, B, C)                                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Task D 配置                                                          │   │
│  │ ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │ │ id: task_d                                                      │ │   │
│  │ │ dependencies: task_a, task_b, task_c                            │ │   │
│  │ │ compress: true          ◄── 启用压缩                            │ │   │
│  │ │ compress_model: flash   ◄── Gemini Flash                        │ │   │
│  │ │ compress_ratio: 0.3     ◄── 压缩到 30%                          │ │   │
│  │ └─────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    build_dependency_context()                        │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  for dep in [task_a, task_b, task_c]:                         │  │   │
│  │  │      output = outputs[dep]                                     │  │   │
│  │  │      compressed = compress_text(output, ratio=0.3, model=flash)│  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       compressor.py                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │  1. 检查缓存 (SHA256 + ratio + model)                        │    │   │
│  │  │     ├─ 命中 → 返回缓存                                       │    │   │
│  │  │     └─ 未命中 → 继续                                         │    │   │
│  │  │                                                              │    │   │
│  │  │  2. 短内容跳过 (<50 行直接返回原文)                           │    │   │
│  │  │                                                              │    │   │
│  │  │  3. 构建压缩 Prompt                                          │    │   │
│  │  │     "将以下内容压缩到原长度的 30% 左右..."                    │    │   │
│  │  │                                                              │    │   │
│  │  │  4. 调用 Gemini CLI                                          │    │   │
│  │  │     gemini -o text -y -m gemini-3-flash-preview -p -          │    │   │
│  │  │                                                              │    │   │
│  │  │  5. 缓存结果并返回                                            │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  压缩结果注入                                                        │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  Task D 原始 content:                                         │  │   │
│  │  │  "基于上游分析结果，综合生成最终报告..."                       │  │   │
│  │  │                                                               │  │   │
│  │  │  + 注入压缩上下文:                                             │  │   │
│  │  │  ---                                                          │  │   │
│  │  │  [依赖任务压缩输出 | 模型: flash, 压缩比: 30%]                 │  │   │
│  │  │                                                               │  │   │
│  │  │  ### task_a                                                   │  │   │
│  │  │  <压缩后的 150 行>                                            │  │   │
│  │  │                                                               │  │   │
│  │  │  ### task_b                                                   │  │   │
│  │  │  <压缩后的 240 行>                                            │  │   │
│  │  │                                                               │  │   │
│  │  │  ### task_c                                                   │  │   │
│  │  │  <压缩后的 90 行>                                             │  │   │
│  │  │  ---                                                          │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  Task D 执行 (Codex/Claude/Gemini)                                   │  │
│  │  输入: 原始 content + 压缩后的依赖上下文 (~480 行 vs 原始 1600 行)   │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流

```
                    ┌────────────────┐
                    │  Task 输出     │
                    │  (500-800 行)  │
                    └───────┬────────┘
                            │
                            ▼
                    ┌────────────────┐
                    │  缓存检查      │
                    │  SHA256+ratio  │
                    └───────┬────────┘
                            │
              ┌─────────────┼─────────────┐
              │ 命中        │ 未命中       │
              ▼             │             ▼
    ┌──────────────┐        │    ┌──────────────┐
    │ 返回缓存     │        │    │ <50行?       │
    └──────────────┘        │    └──────┬───────┘
                            │           │
                            │     ┌─────┴─────┐
                            │     │ 是        │ 否
                            │     ▼           ▼
                            │ ┌────────┐ ┌────────────┐
                            │ │返回原文│ │Gemini 压缩 │
                            │ └────────┘ └─────┬──────┘
                            │                  │
                            │                  ▼
                            │          ┌────────────┐
                            │          │ 缓存结果   │
                            │          └─────┬──────┘
                            │                │
                            └────────────────┘
                                     │
                                     ▼
                            ┌────────────────┐
                            │ 压缩后输出     │
                            │ (~150-250 行)  │
                            └────────────────┘
```

## 配置示例

```
---TASK---
id: analyzer
backend: codex
---CONTENT---
分析代码结构...

---TASK---
id: synthesizer
dependencies: analyzer
compress: true
compress_model: flash
compress_ratio: 0.3
---CONTENT---
基于分析结果生成报告...
```

## 关键参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `compress` | `false` | 是否启用压缩 |
| `compress_model` | `flash` | 压缩模型 (flash/pro) |
| `compress_ratio` | `0.3` | 目标压缩比 (0.05-1.0) |

## 优势

1. **减少上下文长度** - 1600 行 → 480 行 (70% 压缩)
2. **保留关键信息** - Gemini 智能提取结论和数据
3. **内存缓存** - 相同内容不重复压缩
4. **优雅降级** - 压缩失败时使用原文
